# Паттерн IOptions в C#

## Введение
В процессе разработки приложений на C# часто возникает необходимость работы с конфигурациями (например, строки подключения к базам данных, настройки HTTP-клиентов, параметры для различных сервисов). Прямое использование этих значений в коде приводит к их дублированию и усложняет сопровождение проекта.

Паттерн **IOptions** помогает организовать централизованное управление конфигурациями, позволяя хранить их в файлах (например, `appsettings.json`) и упрощая доступ к ним через механизм внедрения зависимостей (Dependency Injection, DI).

## Полезные ресурсы:
- [Официальная документация Microsoft](https://learn.microsoft.com/ru-ru/aspnet/core/fundamentals/configuration/options?view=aspnetcore-8.0)
- [METANIT.COM — описание использования IOptions](https://metanit.com/sharp/aspnet5/6.3.php)

## Проблема

Когда конфигурации, такие как строки подключения или настройки сервисов, указываются непосредственно в коде, это приводит к:

- Дублированию значений
- Риску пропустить изменения при масштабировании проекта
- Повышению сложности внесения изменений

Примеры:
- Строка подключения объявлена прямо в контексте БД
  ![image](https://github.com/user-attachments/assets/a4c991d4-5c4a-4cb5-ace8-5b078640146a)
- Решение
В конкретном случае, строку подключения можно вынести в appsettings.json, т.к. там уже есть шаблон.
![image](https://github.com/user-attachments/assets/0499123b-92e6-4ea1-98c8-6b35c7e8fb88)

выглядеть будет

![image](https://github.com/user-attachments/assets/1d6cb9a8-6965-4928-a1a9-f1745c60b08d)

А в приложении можно получить

![image](https://github.com/user-attachments/assets/2fc7ed52-9369-436a-9cf6-28786991efa0)

## Внедряем IOptions
В качестве примера возьмем настройки для подключения к БД
- стркоа подключения
- название проекта для миграций
### 1 Создаем класс опций
![image](https://github.com/user-attachments/assets/ac30bc61-626c-47dc-a2f7-4f060ad0a42f)
### 2 Добавляем секцию в appsettings.json
![image](https://github.com/user-attachments/assets/bc80fcd6-562a-4b41-bab1-968d7cfacd44)

**ВАЖНО!!!** чтобы имена свойств в классе с опциями совпадали с названиями полей в appsettings.json

### 3 Регистрируем в DI приложения
![image](https://github.com/user-attachments/assets/e7ad61df-67dc-42b8-8d9c-7cd27133838b)

При регистрации, указывается название получаемой секции, если название не указать, то будет искать по названию класса опции

В примере 

![image](https://github.com/user-attachments/assets/912508bb-95a0-4953-8f83-bd2e4b88720d)

Название секции указано в самой опции ![image](https://github.com/user-attachments/assets/674933ba-ac59-41f1-af84-e113582754c5)
### 4 Различные варианты получения настроек
В ASP.NET Core существуют разные механизмы получения настроек:

- IOptions — используется для получения значений настроек на момент старта приложения.
- IOptionsSnapshot — используется для получения настроек, которые могут изменяться в течение жизненного цикла приложения. Обычно применяется в веб-приложениях с перезагрузкой конфигураций.
- IOptionsMonitor — позволяет отслеживать изменения конфигураций в реальном времени.

Пример использования IOptionsSnapshot:
- через DI в конструкторах классов

![image](https://github.com/user-attachments/assets/e449c4fd-983c-44d8-b7bd-328fde8a053c)

- При старте приложения, когда нужно передать опции для конфигурирования сервисов приложения.

![image](https://github.com/user-attachments/assets/e18f7d00-c4aa-4d77-aae8-54baab10ff8b)

